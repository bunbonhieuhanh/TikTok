<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiktok</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="assets/img/tiktok.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <script src="https://kit.fontawesome.com/d829d3809c.js" crossorigin="anonymous"></script>
</head>

<body>
    <img class="logo" src="./assets/img/TikTok_logo.svg.png" alt="">
    <div class="container">
        <div class="vid">
            <video crossorigin="use-credentials" preload="" playsinline controls autoplay id="videoPlayer"
                src=""></video>
            <div class="option">
                <button id="previousButton"><i class="fa-solid fa-up-long"></i></button>
                <button id="nextButton"><i class="fa-solid fa-down-long"></i></button>
            </div>
            <div class="option2">
                <button><i class="fa-solid fa-heart"></i></button>
                <button class="cmt"><i class="fa-regular fa-comment-dots"></i></button>
                <button><i class="fa-solid fa-share-nodes"></i></button>

            </div>
            <div class="comment">
                <div class="hr"></div>
                <div class="avt">
                    <div>
                        <img class="avturl" src="" alt="">
                    </div>
                    <div class="profile">
                        <div class="name"></div>
                        <div class="username"></div>
                    </div>
                    <div class="fl">
                        Follow
                    </div>
                </div>
                <div class="hr"></div>
                <div class="des">
                </div>
                <div class="nhacnen">
                    <i class="fa-solid fa-music"></i>
                    <p class="music"></p>
                </div>


                <!-- ph·∫ßn comment -->
                <div class="containercmt">
                    <p class="countCmt"></p>
                    <div class="flcmt">
                        <div class="avtcmt">
                            <img src="./assets/img/logo.png" alt="">
                        </div>
                        <form id="commentForm">
                            <input type="text" id="commentInput" placeholder="Add comment...">
                            <div class="icon">
                                <i title="T√¨m ki·∫øm" class="fa-regular fa-face-smile" id="iconButton"></i>
                            </div>
                            <button id="submitButton" type="submit">Post</button>
                        </form>

                    </div>
                    <div class="icon-list" id="iconList">
                        <i>üòÄ</i>
                        <i>üòÑ</i>
                        <i>üòÅ</i>
                        <i>üòÜ</i>
                        <i>üòÖ</i>
                        <i>ü§£</i>
                        <i>üòÇ</i>
                        <i>üôÇ</i>
                        <i>üôÉ</i>
                        <i>ü´†</i>
                        <i>üòâ</i>
                        <i>üòä</i>
                        <i>üòá</i>
                    </div><br>
                    <div class="hr"></div>
                    <div class="cmtdown cmtdown-grid" id="commentsContainer"></div>
                </div>
                <!--end ph·∫ßn comment -->
            </div>
        </div>
    </div>




    <!-- x·ª≠ l√Ω logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#iconButton").click(function () {
                $("#iconList").toggle();
            });

            $(".icon-list i").click(function () {
                var emoji = $(this).text();
                $("#commentInput").val($("#commentInput").val() + emoji + " ");
                $("#iconList").hide();
            });
        });

        $(window).on('load', function () {
            $("#iconList").hide();
        });
    </script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        // L·∫•y tham chi·∫øu t·ªõi c√°c ph·∫ßn t·ª≠ DOM
        const videoPlayer = document.getElementById('videoPlayer');
        const previousButton = document.getElementById('previousButton');
        const nextButton = document.getElementById('nextButton');
        const commentForm = document.getElementById('commentForm');
        const commentInput = document.getElementById('commentInput');
        const commentsContainer = document.getElementById('commentsContainer');
        const countCmt = document.querySelector('.countCmt');
        // Kh·ªüi t·∫°o bi·∫øn l∆∞u tr·ªØ danh s√°ch video
        let videoList = [];

        // L·∫•y d·ªØ li·ªáu t·ª´ API
        function fetchVideoData() {
            axios.get('http://localhost:3000/videos')
                .then(response => {
                    // G√°n danh s√°ch video t·ª´ API v√†o bi·∫øn videoList
                    videoList = response.data;
                    showVideo(0);
                    fetchComments(videoList[0].comments);
                    fillData(videoList[0]); // G·ªçi h√†m fillData ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu video
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Hi·ªÉn th·ªã video
        function showVideo(index) {
            const video = videoList[index];
            videoPlayer.src = video.url;
            currentVideoIndex = index;
            fetchComments(video.comments);
            fillData(video); // G·ªçi h√†m fillData ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu video
        }

        function fillData(video) {
            document.getElementById('videoPlayer').src = video.url;

            // T√¨m c√°c ph·∫ßn t·ª≠ d·ª±a tr√™n class name v√† g√°n gi√° tr·ªã t·ª´ b·∫£ng JSON
            const nameElements = document.getElementsByClassName('name');
            for (let i = 0; i < nameElements.length; i++) {
                nameElements[i].innerText = video.name;
            }

            const usernameElements = document.getElementsByClassName('username');
            for (let i = 0; i < usernameElements.length; i++) {
                usernameElements[i].innerText = video.username;
            }

            const desElements = document.getElementsByClassName('des');
            for (let i = 0; i < desElements.length; i++) {
                desElements[i].innerHTML = video.des;
            }

            const musicElements = document.getElementsByClassName('music');
            for (let i = 0; i < musicElements.length; i++) {
                musicElements[i].innerHTML = video.music;
            }

            const avtElements = document.getElementsByClassName('avturl');
  for (let i = 0; i < avtElements.length; i++) {
    const img = avtElements[i];
    img.src = video.avturl; // L·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh t·ª´ tr∆∞·ªùng avturl c·ªßa d·ªØ li·ªáu video
  }
        }
        // L·∫•y danh s√°ch b√¨nh lu·∫≠n t·ª´ API
        function fetchComments(commentIds) {
            axios.get('http://localhost:3000/comments')
                .then(response => {
                    const comments = response.data;
                    const videoComments = comments.filter(comment => commentIds.includes(comment.id));
                    displayComments(videoComments);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }


        function displayComments(comments) {
            commentsContainer.innerHTML = '';

            for (let i = 0; i < comments.length; i++) {
                const comment = comments[i];

                const div = document.createElement('div');
                div.classList.add('comment-wrapper'); // Th√™m class t√πy ch·ªânh cho th·∫ª <div> (n·∫øu c·∫ßn)

                const avatar = document.createElement('img');
                avatar.src = getAvatarUrl(comment.userId); // L·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh t·ª´ d·ªØ li·ªáu video
                avatar.classList.add('avatar');

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('comment-info'); // Th√™m class t√πy ch·ªânh cho ph·∫ßn th√¥ng tin (n·∫øu c·∫ßn)

                const liName = document.createElement('li');
                liName.innerText = `${comment.user}`;
                liName.classList.add('usercmt')

                const liText = document.createElement('li');
                liText.innerText = `${comment.text}`;
                liText.classList.add('textcmt')

                const liTime = document.createElement('li');
                liTime.innerText = `${comment.time}`;
                liTime.classList.add('timecmt')

                infoDiv.appendChild(liName);
                infoDiv.appendChild(liText);
                infoDiv.appendChild(liTime);

                div.appendChild(avatar);
                div.appendChild(infoDiv);
                commentsContainer.appendChild(div);
            }
            countCmt.textContent = comments.length + ' comment' + (comments.length !== 1 ? 's' : ''); // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng b√¨nh lu·∫≠n
        }

        function getAvatarUrl(userId) {
            const video = videoList.find(video => video.id === userId);
            if (video) {
                return video.avturl; // L·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh t·ª´ tr∆∞·ªùng avturl c·ªßa d·ªØ li·ªáu video
            }
            return './assets/img/logo.png';
        }
        // G·ª≠i b√¨nh lu·∫≠n m·ªõi
        function postComment(videoId, commentText) {
            axios.post('http://localhost:3000/comments', { text: commentText })
                .then(response => {
                    const newComment = response.data;
                    const video = videoList[currentVideoIndex];
                    video.comments.push(newComment.id); // Th√™m ID b√¨nh lu·∫≠n v√†o m·∫£ng comments c·ªßa video hi·ªán t·∫°i
                    commentInput.value = '';
                    countCmt.textContent = video.comments.length + ' comment' + (video.comments.length !== 1 ? 's' : ''); // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng b√¨nh lu·∫≠n
                    // C·∫≠p nh·∫≠t b·∫£ng videos tr√™n API server
                    axios.put(`http://localhost:3000/videos/${videoId}`, video)
                        .then(response => {
                            console.log('Video updated:', response.data);
                            fetchComments(video.comments); // G·ªçi l·∫°i fetchComments ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch b√¨nh lu·∫≠n
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Chuy·ªÉn video l√™n
        function playPreviousVideo() {
            if (currentVideoIndex > 0) {
                currentVideoIndex--;
                showVideo(currentVideoIndex);
            }
        }

        // Chuy·ªÉn video xu·ªëng
        function playNextVideo() {
            if (currentVideoIndex < videoList.length - 1) {
                currentVideoIndex++;
                showVideo(currentVideoIndex);
            }
        }

        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g·ª≠i b√¨nh lu·∫≠n
        function handleCommentSubmit(event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán submit m·∫∑c ƒë·ªãnh c·ªßa form
            const commentText = commentInput.value.trim();
            if (commentText !== '') {
                commentInput.disabled = true; // V√¥ hi·ªáu h√≥a input b√¨nh lu·∫≠n ƒë·ªÉ ngƒÉn ng∆∞·ªùi d√πng nh·∫≠p li·ªáu m·ªõi
                postComment(videoList[currentVideoIndex].id, commentText);
            }
        }

        // G√°n s·ª± ki·ªán click cho c√°c n√∫t chuy·ªÉn video
        // G√°n s·ª± ki·ªán click cho n√∫t Previous
        previousButton.addEventListener('click', function (event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán click m·∫∑c ƒë·ªãnh
            playPreviousVideo();
        });

        // G√°n s·ª± ki·ªán click cho n√∫t Next
        nextButton.addEventListener('click', function (event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán click m·∫∑c ƒë·ªãnh
            playNextVideo();
        });

        // G√°n s·ª± ki·ªán submit cho form Comment
        commentForm.addEventListener('submit', function (event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n s·ª± ki·ªán submit m·∫∑c ƒë·ªãnh c·ªßa form
            handleCommentSubmit(event);
        });

        // L·∫•y d·ªØ li·ªáu video khi trang t·∫£i xong
        window.addEventListener('DOMContentLoaded', fetchVideoData);
    </script>
</body>

</html>